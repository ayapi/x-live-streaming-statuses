# Requirements Document

## Introduction

X（Twitter）のライブ配信コメントをリアルタイムで取得し、コメント管理アプリ「わんコメ」（OneComme）のHTTP APIにコメントをPOSTするブリッジアプリケーションの要件を定義する。

### 技術的背景と制約

- **X Live配信チャットAPI**: X（Twitter）にはライブ動画配信のチャットコメントを取得する公式APIが存在しない（2021年のPeriscope API廃止以降、代替は提供されていない）。そのため、ブラウザ自動化やスクレイピング等の非公式手段でコメントを取得する必要がある。
- **わんコメHTTP API**: ローカルHTTPサーバー（デフォルトポート `11180`）で動作し、`POST /api/comments` エンドポイントでコメントを注入できる。

## Requirements

### Requirement 1: Xライブ配信コメントのリアルタイム取得

**Objective:** 配信者として、Xのライブ配信中のコメント（チャット）をリアルタイムで取得したい。これにより、わんコメで他プラットフォームのコメントと統合管理できるようになる。

#### Acceptance Criteria

1. When ユーザーがXライブ配信のURLまたは識別子を指定して取得を開始した場合, the ブリッジアプリケーション shall 該当ライブ配信のコメントをリアルタイムで取得し始める
2. When 新しいコメントがライブ配信に投稿された場合, the ブリッジアプリケーション shall コメントのテキスト、投稿者名、投稿者ID、プロフィール画像URL、タイムスタンプを取得する
3. While ライブ配信が進行中である間, the ブリッジアプリケーション shall 継続的にコメントを監視し、新規コメントを検出する
4. When ライブ配信が終了した場合, the ブリッジアプリケーション shall コメント取得を停止し、ユーザーに配信終了を通知する

### Requirement 2: わんコメへのコメント送信

**Objective:** 配信者として、取得したXライブ配信コメントをわんコメにリアルタイムで反映させたい。これにより、わんコメの表示・読み上げ・管理機能をXライブコメントにも活用できる。

#### Acceptance Criteria

1. When Xライブ配信から新しいコメントが取得された場合, the ブリッジアプリケーション shall わんコメの `POST /api/comments` エンドポイントにコメントデータをJSON形式で送信する
2. The ブリッジアプリケーション shall 送信するコメントデータに以下のフィールドを含める: `service.id`（わんコメの枠ID）、`comment.id`（一意のコメントID）、`comment.userId`、`comment.name`、`comment.comment`、`comment.profileImage`、`comment.timestamp`
3. When わんコメへのPOSTが成功した場合（200 OK）, the ブリッジアプリケーション shall 該当コメントを送信済みとして記録する
4. If わんコメへのPOSTが失敗した場合（接続エラーまたは非200レスポンス）, the ブリッジアプリケーション shall エラーをログに記録し、リトライを試みる

### Requirement 3: 接続設定

**Objective:** 配信者として、XライブのURLとわんコメの接続先を簡単に設定したい。これにより、技術的な知識がなくても利用を開始できる。

#### Acceptance Criteria

1. The ブリッジアプリケーション shall Xライブ配信のURL（またはブロードキャストID）を入力として受け付ける
2. The ブリッジアプリケーション shall わんコメのホスト・ポート（デフォルト: `localhost:11180`）を設定できる
3. The ブリッジアプリケーション shall わんコメの枠ID（`service.id`）を設定できる
4. When アプリケーション起動時に必須設定が不足している場合, the ブリッジアプリケーション shall 不足している設定項目をユーザーに明示する

### Requirement 4: エラーハンドリングと安定性

**Objective:** 配信者として、長時間の配信中もアプリケーションが安定して動作し続けてほしい。これにより、配信中にコメント連携が途切れるリスクを軽減できる。

#### Acceptance Criteria

1. If Xライブ配信へのコメント取得接続が切断された場合, the ブリッジアプリケーション shall 自動的に再接続を試みる
2. If わんコメのHTTPサーバーに接続できない場合, the ブリッジアプリケーション shall エラーを表示し、接続が回復するまでコメントをバッファリングする
3. While アプリケーションが動作中である間, the ブリッジアプリケーション shall 処理したコメント数、エラー数などの動作状況をログに出力する
4. If 予期しないエラーが発生した場合, the ブリッジアプリケーション shall クラッシュせずにエラーをログに記録し、可能な限り動作を継続する

### Requirement 5: 重複コメント防止

**Objective:** 配信者として、同じコメントがわんコメに複数回送信されないようにしたい。これにより、わんコメ上でのコメント表示が正確に保たれる。

#### Acceptance Criteria

1. The ブリッジアプリケーション shall 送信済みコメントのIDを記録し、同一コメントの重複送信を防止する
2. When 再接続によりすでに取得済みのコメントが再度取得された場合, the ブリッジアプリケーション shall 重複コメントをスキップする
